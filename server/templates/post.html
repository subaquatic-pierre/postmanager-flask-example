{% extends 'layout.html' %} {% block main %}

<section class="py-5 container">
  <div class="row py-lg-5">
    <div class="col-lg-6 col-md-8 mx-auto">
      <h1 class="fw-light text-center">
        Post Title: {{data.post.meta_data.title}}
      </h1>
      <p class="lead text-muted">Data:</p>
      <div data-data="{{ json_dump }}" id="dataDiv">
        <pre id="preTag"></pre>
      </div>
      <p class="text-center">
        <button id="deleteButton" class="btn btn-danger my-2">Delete</button>
        <a
          href="/posts/update/{{data.post.meta_data.id}}"
          class="btn btn-secondary my-2"
          >Edit</a
        >
      </p>
    </div>
  </div>
</section>

<script>
  const generateValidateUrl = (data) => {
    const baseUrl = "/validate?data=";
    return baseUrl + JSON.stringify(data);
  };

  const deleteRequest = (url) => {
    return fetch(url, {
      method: "DELETE", // *GET, POST, PUT, DELETE, etc.
      mode: "cors", // no-cors, *cors, same-origin
      cache: "no-cache", // *default, no-cache, reload, force-cache, only-if-cached
      credentials: "same-origin", // include, *same-origin, omit
      redirect: "follow", // manual, *follow, error
      referrerPolicy: "no-referrer", // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
    });
  };

  const handleDelete = async () => {
    const postId = "{{data.post.meta_data.id}}";
    const deleteUrl = `/posts/${postId}`;

    try {
      const response = await deleteRequest(deleteUrl);
      const resData = await response.json();

      if (resData.error) {
        const data = {
          title: "Delete Failure",
          data: error,
        };
        window.location.assign(generateValidateUrl(data));
      }

      const validateData = {
        title: "Delete Success",
        data: resData,
      };

      window.location.assign(generateValidateUrl(validateData));
    } catch (error) {
      const validateData = {
        title: "Delete Failure",
        data: error,
      };

      window.location.assign(generateValidateUrl(validateData));
    }
  };

  document.getElementById("deleteButton").onclick = handleDelete;

  window.addEventListener("load", () => {
    const dataDiv = document.getElementById("dataDiv");
    const data = dataDiv.dataset.data;

    const preTag = document.getElementById("preTag");
    preTag.innerHTML = JSON.stringify(JSON.parse(data).post, null, 4);
  });
</script>

{% endblock main %}
