{% extends 'layout.html' %} {% block main %}

<div class="py-5 text-center">
  <h2>Create Post</h2>
  <p class="lead">Update post below</p>
</div>

<form class="row g-3" id="postForm">
  <div class="col-12 mb-5">
    <div class="col-12">
      <h3>Meta data</h3>
    </div>
    <div class="col-md-12">
      <label for="inputEmail4" class="form-label">Post Title</label>
      <input
        type="text"
        class="form-control w-100"
        id="postTitle"
        name="postTitle"
        value="{{post.meta_data.title}}"
      />
    </div>
  </div>

  <div class="col-12 d-flex justify-content-center mb-3">
    <hr class="dropdown-divider w-50" />
  </div>

  <div class="col-12 mb-5">
    <div class="col-12">
      <h3>Content</h3>
    </div>

    <div class="col-md-12">
      <textarea
        class="form-control w-100"
        rows="5"
        id="postContent"
        name="postContent"
      >
{{post.content.text}}</textarea
      >
    </div>
  </div>

  <div class="col-12 d-flex justify-content-end">
    <button type="submit" class="ml-auto btn btn-primary">Submit</button>
  </div>
</form>

<script>
  const form = document.getElementById("postForm");

  const putRequest = async (url, data) => {
    return fetch(url, {
      method: "PUT", // *GET, POST, PUT, DELETE, etc.
      mode: "cors", // no-cors, *cors, same-origin
      cache: "no-cache", // *default, no-cache, reload, force-cache, only-if-cached
      credentials: "same-origin", // include, *same-origin, omit
      headers: {
        "Content-Type": "application/json",
        // 'Content-Type': 'application/x-www-form-urlencoded',
      },
      redirect: "follow", // manual, *follow, error
      referrerPolicy: "no-referrer", // no-referrer, *no-referrer-when-downgrade, origin, origin-when-cross-origin, same-origin, strict-origin, strict-origin-when-cross-origin, unsafe-url
      body: JSON.stringify(data), // body data type must match "Content-Type" header
    });
  };

  const generateValidateUrl = (data) => {
    const baseUrl = "/validate?data=";
    return baseUrl + JSON.stringify(data);
  };

  const handlePostRequest = async (data) => {
    const postId = "{{post.id}}";
    const updateUrl = `/posts/${postId}`;
    try {
      const response = await putRequest(updateUrl, data);
      const resData = await response.json();

      const validateData = {
        title: "Update Success",
        data: resData,
      };

      window.location.assign(generateValidateUrl(validateData));
    } catch (error) {
      const errorData = {
        title: "Update Failure",
        data: error,
      };

      window.location.assign(generateValidateUrl(errorData));
    }
  };

  const handleSubmitClick = (e) => {
    event.preventDefault();

    const postTitle = document.getElementById("postTitle");
    const postContent = document.getElementById("postContent");

    const data = {
      metaData: {
        title: postTitle.value,
      },
      content: {
        text: postContent.value,
      },
    };

    handlePostRequest(data);
  };

  form.addEventListener("submit", handleSubmitClick);
</script>

{% endblock main %}
